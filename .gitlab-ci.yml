stages:
  - check
  - build
  - release

# Run this pipeline only for new tags
workflow:
  rules:
    - if: '$CI_COMMIT_TAG'

check-job:
  image: nimlang/nim:2.0.4-alpine-onbuild
  stage: check
  script:
    - nimble refresh
    - nimble check

build-job:
  image: nimlang/nim:2.0.4-alpine-onbuild
  stage: build
  script:
    - echo "Compiling the code..."
    - nimble build -d:ssl -d:release

release-job:
  stage: release
  script:
    - git config --global user.email "ci@example.com"
    - git config --global user.name "CI/CD Pipeline"
    - git fetch origin
    - git checkout trunk
    - git merge --ff-only $CI_COMMIT_TAG
    - git tag $CI_COMMIT_TAG
    - git push origin trunk
    - git push origin $CI_COMMIT_TAG
  only:
    - tags
  dependencies:
    - build-job
